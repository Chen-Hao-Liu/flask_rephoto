{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Image Capture{% endblock %}</h1>
{% endblock %}

{% if post != 0 %}
  {% set pic = 'myImgs/' + post['imgFile'] %}
{% else %}
  {% set pic = 'imgs/slideImg.jpg' %}
{% endif %}

{% block content %}
<article>
 <div class="container">
  <div class="row">
   <div class="col-lg-8 col-md-10 mx-auto" style="position: relative; display: flex; flex-direction: column;">

  <div id="parent" style="position:relative; align-items: center; justify-content: center; margin: auto; height:700px;">
    <video class="children" style="position: absolute; top: 0; left: 0; transform: translateX(-50%);" id="vid" autoplay playsinline></video>
    {% if post != 0 %}
      <img class="children" style="opacity: 0.4; position: absolute; top: 0; left: 0; transform: translateX(-50%);" id="overlay" src="/static/myImgs/{{ post['imgFile'] }}" alt="Cover Image" width="{{ post['wd'] }}" height="{{ post['ht'] }}">
    {% else %}
      <img class="children" style="display:none;" id="overlay" src="/static/imgs/default.png" alt="Cover Image" width="200" height="200">
    {% endif %}
  </div>

  {% if post != 0 %}
    <input type="hidden" id="IDPath" name="IDPath" value="{{ url_for('blog.imageCapture', id=post['id']) }}">
    <input type="hidden" id="redirect" name="redirect" value="{{ post['id'] }}">
  {% else %}
    <input type="hidden" id="IDPath" name="IDPath" value="{{ url_for('blog.imageCapture', id=0) }}">
    <input type="hidden" id="redirect" name="redirect" value="0">
  {% endif %}

  <div>
    <div id="take" style="text-align:center;"><button id="takePic">Take Picture</button></div>
    <div id="uploadPic" style="text-align:center;">
      <input type="text" placeholder="Picture Title" id="picName">
      <button id="upload">Upload Picture</button>
    </div>
  </div>

    </div>
   </div>
 </div>
</article>

    <script type="text/javascript" src="{{ url_for('static', filename='jquery-3.5.1.min.js') }}"></script>
    <script>
      //Temporarily hide upload button
      document.getElementById("uploadPic").style.display = "none";
      //overlay styling
      var oStyle = "";

      //Access media devices and capture image
      navigator.mediaDevices.getUserMedia({
        video: true
      })
      .then(function(stream){
        //Set dimensions
        vid.onloadedmetadata = function() {
          //this.width = overlay.width = this.videoWidth;
          //this.height = overlay.height = this.videoHeight;
          this.width = this.videoWidth;
          this.height = this.videoHeight;

          var parent = document.getElementById('parent');
          var v = document.getElementById('vid');
          var o = document.getElementById('overlay');
          var pheight = parent.clientHeight;
          var vtrans = pheight * 50/100 - this.height/2;
          var otrans = pheight * 50/100 - o.height/2;
          v.style.transform = "translate(-50%, " + String(vtrans) + "px)";
          o.style.transform = "translate(-50%, " + String(otrans) + "px)";
          //Save style to be updated later with overlay
          oStyle = "opacity: 1; position: absolute; top: 0; left: 0; transform: translate(-50%, " + String(vtrans) + "px);";
        }
        window.stream = stream;
        vid.srcObject = stream;

        document.getElementById("takePic").onclick = function() {
          //show upload button and hide take button
          document.getElementById("uploadPic").style.display = "block";
          document.getElementById("take").style.display = "none";

          //Create canvas and take picture
          var c = document.createElement('canvas');
          c.width = vid.videoWidth;
          c.height = vid.videoHeight;
          c.getContext('2d').drawImage(vid, 0, 0);
          c.toBlob(capturedImage, 'image/png');
        };
      })
      .catch(function(err){
        // Handle the error
        console.error(err);
      });

      function capturedImage(blob){
        // creates DOMString containing a URL representing the object
        var url = URL.createObjectURL(blob);

        //Change overlay image
        overlay.src = url;
        overlay.style = oStyle;
        overlay.width = vid.videoWidth;
        overlay.height = vid.videoHeight;

        //Save dimensions of video
        var width = vid.videoWidth;
        var height = vid.videoHeight;

        //Listener for uploading file
        document.getElementById("upload").onclick = function() {
          var fdata = new FormData();
          fdata.append('file', blob, document.getElementById('picName').value.concat('.png'));
          fdata.append('width', width);
          fdata.append('height', height);

          $.ajax({
            type: "POST",
            enctype: 'multipart/form-data',
            url: document.getElementById("IDPath").value,
            data: fdata,
            processData: false,
            contentType: false,
            cache: false,
            success: function(){
              if (document.getElementById('redirect').value != 0){
                window.location.href = "https://chliu.pythonanywhere.com/" + document.getElementById('redirect').value + "/update";
              }else{
                window.location.href = "https://chliu.pythonanywhere.com/create";
              }
            }
          });
        };

        //Remove video stream
        URL.revokeObjectURL(vid.src);
        vid.parentNode.removeChild(vid);
      }
    </script>
{% endblock %}